<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oracoin - 실시간 암호화폐 추세 예측</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5892610452724367"
     crossorigin="anonymous"></script>
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        .predict-up { color: #22c55e; }
        .predict-down { color: #ef4444; }
        .predict-stable { color: #64748b; }
        .control-btn.active { background-color: #3b82f6; color: white; box-shadow: 0 0 15px rgba(59, 130, 246, 0.5); }
        .star-icon { cursor: pointer; transition: color 0.2s, transform 0.2s; }
        .star-icon:hover { transform: scale(1.2); }
        .star-icon.favorited { color: #facc15; }
        #modal-overlay { background-color: rgba(0, 0, 0, 0.7); backdrop-filter: blur(4px); }
        #coin-list-sidebar::-webkit-scrollbar { width: 4px; }
        #coin-list-sidebar::-webkit-scrollbar-track { background: #1f2937; }
        #coin-list-sidebar::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 2px; }
        #limit-message { transition: opacity 0.5s; }
        .skeleton-card { background-color: #1f2937; border-radius: 1rem; padding: 1.25rem; }
        .skeleton { background-color: #374151; border-radius: 0.5rem; }
    </style>
</head>
<body class="bg-gray-900 text-white overflow-hidden">

    <div class="flex h-screen">
        <!-- 사이드바 오버레이 (모바일용) -->
        <div id="sidebar-overlay" class="fixed inset-0 bg-black/50 z-20 hidden lg:hidden"></div>

        <!-- 코인 목록 사이드바 -->
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-30 w-64 bg-gray-800/80 backdrop-blur-sm p-4 flex flex-col h-full border-r border-gray-700 transition-transform duration-300 ease-in-out transform -translate-x-full lg:relative lg:translate-x-0">
            <h2 class="text-xl font-bold mb-2 text-center" data-lang-key="sidebar_title">코인 목록 (상위 100)</h2>
            <p id="limit-message" class="text-center text-red-400 text-xs mb-2 h-4 opacity-0" data-lang-key="limit_message">최대 6개까지 추가 가능합니다.</p>
            <div id="coin-list-sidebar" class="flex-grow overflow-y-auto"></div>
        </aside>

        <!-- 메인 컨텐츠 -->
        <main class="flex-grow p-4 md:p-6 overflow-y-auto h-full relative">
            <!-- 사이드바 토글 버튼 -->
            <button id="sidebar-toggle" class="fixed top-4 left-4 z-40 p-2 bg-gray-700/50 backdrop-blur-sm rounded-md text-white hover:bg-gray-600 transition-colors lg:hidden">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                </svg>
            </button>

            <div class="container mx-auto max-w-7xl">
                <header class="text-center mb-4 relative">
                    <h1 class="text-3xl sm:text-4xl font-bold mb-2 bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-500" data-lang-key="main_title">Oracoin</h1>
                    <p class="text-gray-400 text-sm sm:text-base" data-lang-key="main_subtitle">실시간 암호화폐 추세 예측</p>
                    <!-- 언어 선택 -->
                    <div class="absolute top-0 right-0 flex space-x-2">
                        <button id="lang-ko" class="lang-btn control-btn px-3 py-1 text-sm rounded-md">KO</button>
                        <button id="lang-en" class="lang-btn control-btn px-3 py-1 text-sm rounded-md">EN</button>
                    </div>
                </header>

                <div class="flex justify-center mb-4">
                    <div class="bg-gray-800/50 backdrop-blur-sm rounded-lg p-1 flex space-x-1 border border-gray-700">
                        <button id="btn-1h" class="timeframe-btn control-btn px-4 py-2 text-sm font-medium text-gray-300 rounded-md hover:bg-gray-700" data-lang-key="time_1h">1시간</button>
                        <button id="btn-4h" class="timeframe-btn control-btn px-4 py-2 text-sm font-medium text-gray-300 rounded-md hover:bg-gray-700" data-lang-key="time_4h">4시간</button>
                        <button id="btn-24h" class="timeframe-btn control-btn px-4 py-2 text-sm font-medium text-gray-300 rounded-md hover:bg-gray-700 active" data-lang-key="time_24h">24시간</button>
                    </div>
                </div>

                <div class="bg-gray-800/50 backdrop-blur-sm border border-gray-700 p-4 rounded-xl mb-6 space-y-4 md:space-y-0 md:flex md:items-center md:justify-between">
                    <div class="relative flex-grow md:max-w-xs">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-3"><svg class="w-5 h-5 text-gray-400" viewBox="0 0 24 24" fill="none"><path d="M21 21L15.803 15.803M15.803 15.803C17.2236 14.3824 18 12.4731 18 10.5C18 6.35786 14.6421 3 10.5 3C6.35786 3 3 6.35786 3 10.5C3 14.6421 6.35786 18 10.5 18C12.4731 18 14.3824 17.2236 15.803 15.803Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg></span>
                        <input id="search-input" type="text" data-lang-key="search_placeholder" placeholder="추가된 코인 검색..." class="w-full bg-gray-700 text-white placeholder-gray-400 border border-gray-600 rounded-lg py-2 pl-10 pr-4 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="flex items-center justify-center space-x-2">
                        <button id="sort-name" class="sort-btn control-btn px-3 py-2 text-sm font-medium text-gray-300 bg-gray-700 rounded-md hover:bg-gray-600" data-lang-key="sort_name">이름순</button>
                        <button id="sort-price" class="sort-btn control-btn px-3 py-2 text-sm font-medium text-gray-300 bg-gray-700 rounded-md hover:bg-gray-600" data-lang-key="sort_price">가격순</button>
                        <button id="sort-change" class="sort-btn control-btn px-3 py-2 text-sm font-medium text-gray-300 bg-gray-700 rounded-md hover:bg-gray-600" data-lang-key="sort_change">변동률순</button>
                    </div>
                    <div class="flex items-center justify-center">
                        <label for="watchlist-toggle" class="flex items-center cursor-pointer"><span class="mr-3 text-sm font-medium text-gray-300" data-lang-key="watchlist">⭐ 관심 목록</span><div class="relative"><input type="checkbox" id="watchlist-toggle" class="sr-only"><div class="block bg-gray-600 w-14 h-8 rounded-full"></div><div class="dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition"></div></div></label>
                    </div>
                </div>

                <div id="loading-indicator" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-2 xl:grid-cols-3 gap-6"></div>
                <div id="crypto-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-2 xl:grid-cols-3 gap-6"></div>
                <div id="no-results" class="hidden text-center text-gray-400 py-10 col-span-full"></div>

                <div class="mt-16">
                    <h2 class="text-3xl font-bold text-center mb-8 bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-500" data-lang-key="news_title">최신 암호화폐 뉴스</h2>
                    <div id="news-container" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
                </div>

                <footer class="text-center mt-12 text-gray-500 text-sm">
                    <p data-lang-key="data_provider">데이터 제공: <a href="https://www.coingecko.com/" target="_blank" class="underline hover:text-blue-400">CoinGecko</a></p>
                    <p id="last-updated"></p>
                    <p class="mt-4 text-xs text-gray-600" data-lang-key="disclaimer"></p>
                </footer>
            </div>
        </main>
    </div>
    
    <div id="modal-overlay" class="fixed inset-0 items-center justify-center hidden z-50 p-4"><div id="modal-content" class="bg-gray-800 rounded-xl shadow-2xl p-6 w-full max-w-2xl mx-auto relative transform transition-all duration-300 scale-95 opacity-0"><button id="modal-close" class="absolute top-4 right-4 text-gray-400 hover:text-white">&times;</button></div></div>

    <script>
        // DOM 요소
        const elements = {
            sidebar: document.getElementById('sidebar'),
            sidebarToggle: document.getElementById('sidebar-toggle'),
            sidebarOverlay: document.getElementById('sidebar-overlay'),
            cryptoContainer: document.getElementById('crypto-container'),
            loadingIndicator: document.getElementById('loading-indicator'),
            lastUpdated: document.getElementById('last-updated'),
            searchInput: document.getElementById('search-input'),
            sortButtons: document.querySelectorAll('.sort-btn'),
            watchlistToggle: document.getElementById('watchlist-toggle'),
            noResults: document.getElementById('no-results'),
            modalOverlay: document.getElementById('modal-overlay'),
            modalContent: document.getElementById('modal-content'),
            modalClose: document.getElementById('modal-close'),
            coinListSidebar: document.getElementById('coin-list-sidebar'),
            timeframeButtons: document.querySelectorAll('.timeframe-btn'),
            limitMessage: document.getElementById('limit-message'),
            newsContainer: document.getElementById('news-container'),
            langButtons: document.querySelectorAll('.lang-btn'),
        };

        // API 키
        const apiKey = 'CG-xmGqWe2JgRKTWjf1WSPT9saQ';

        // 상태 관리
        let state = {
            displayedCoinsData: [],
            allCoinsForSidebar: [],
            displayedCoinIds: new Set(['bitcoin', 'ethereum', 'ripple', 'dogecoin', 'solana', 'cardano']),
            watchlist: JSON.parse(localStorage.getItem('cryptoWatchlist')) || [],
            currentSort: { key: 'market_cap_rank', order: 'asc' },
            showWatchlistOnly: false,
            searchTerm: '',
            activeTimeframe: '24h',
            lang: 'ko',
            currency: 'krw',
            chartInstance: null,
        };

        const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        // 다국어 텍스트
        const translations = {
            ko: {
                sidebar_title: "코인 목록 (상위 100)",
                limit_message: "최대 6개까지 추가 가능합니다.",
                main_title: "Oracoin",
                main_subtitle: "실시간 암호화폐 추세 예측",
                time_1h: "1시간", time_4h: "4시간", time_24h: "24시간",
                search_placeholder: "추가된 코인 검색...",
                sort_name: "이름순", sort_price: "가격순", sort_change: "변동률순",
                watchlist: "⭐ 관심 목록",
                no_results: "표시할 코인이 없습니다. 사이드바에서 코인을 추가해주세요.",
                news_title: "최신 암호화폐 뉴스",
                data_provider: "데이터 제공: ",
                last_update: "마지막 업데이트: ",
                loading: "최신 데이터를 불러오는 중입니다...",
                predict_up: "상승 추세", predict_down: "하락 추세", predict_stable: "보합세",
                basis_up: "근거: {timeframe} 변동률({change}%)이 {threshold}%를 초과했습니다.",
                basis_down: "근거: {timeframe} 변동률({change}%)이 -{threshold}% 미만입니다.",
                basis_stable: "근거: {timeframe} 변동률({change}%)이 -{threshold}% ~ {threshold}% 사이입니다.",
                modal_price: "현재 가격:", modal_mcap: "시가총액:", modal_vol: "24시간 거래량:",
                modal_high: "24시간 최고가:", modal_low: "24시간 최저가:",
                modal_chart_title: "7일 가격 차트", modal_desc_title: "코인 설명", modal_links_title: "공식 링크", modal_website: "웹사이트 방문",
                news1_title: "비트코인, 주요 저항선 돌파 시도… 시장 전망은?", news1_source: "코인 데스크 코리아", news1_time: "2시간 전",
                news2_title: "이더리움 현물 ETF 승인 이후, 다음 알트코인 주자는?", news2_source: "블록체인 투데이", news2_time: "5시간 전",
                news3_title: "미국 SEC, 암호화폐 규제 관련 새로운 가이드라인 발표", news3_source: "디지털 에셋", news3_time: "1일 전",
                news4_title: "솔라나 생태계, 밈코인 열풍에 힘입어 급성장", news4_source: "크립토 뉴스", news4_time: "2일 전",
                disclaimer: "법적 고지: Oracoin에서 제공하는 모든 정보는 정보 제공 목적으로만 사용되며, 투자 조언으로 간주되어서는 안 됩니다. 암호화폐 투자는 원금 손실의 위험을 수반합니다. 모든 투자 결정은 본인의 책임하에 신중하게 이루어져야 합니다.",
            },
            en: {
                sidebar_title: "Coin List (Top 100)",
                limit_message: "You can add up to 6 coins.",
                main_title: "Oracoin",
                main_subtitle: "Real-Time Crypto Trend Predictor",
                time_1h: "1H", time_4h: "4H", time_24h: "24H",
                search_placeholder: "Search added coins...",
                sort_name: "Name", sort_price: "Price", sort_change: "Change",
                watchlist: "⭐ Watchlist",
                no_results: "No coins to display. Please add coins from the sidebar.",
                news_title: "Latest Crypto News",
                data_provider: "Data provided by: ",
                last_update: "Last updated: ",
                loading: "Loading latest data...",
                predict_up: "Uptrend", predict_down: "Downtrend", predict_stable: "Stable",
                basis_up: "Basis: {timeframe} change ({change}%) exceeded {threshold}%.",
                basis_down: "Basis: {timeframe} change ({change}%) is below -{threshold}%.",
                basis_stable: "Basis: {timeframe} change ({change}%) is between -{threshold}% and {threshold}%.",
                modal_price: "Current Price:", modal_mcap: "Market Cap:", modal_vol: "24h Volume:",
                modal_high: "24h High:", modal_low: "24h Low:",
                modal_chart_title: "7-Day Price Chart", modal_desc_title: "Coin Description", modal_links_title: "Official Links", modal_website: "Visit Website",
                news1_title: "Bitcoin Attempts to Break Major Resistance... What's the Market Outlook?", news1_source: "CoinDesk", news1_time: "2 hours ago",
                news2_title: "After Ethereum Spot ETF Approval, Who's the Next Altcoin Runner?", news2_source: "Blockchain Today", news2_time: "5 hours ago",
                news3_title: "US SEC Announces New Guidelines on Crypto Regulation", news3_source: "Digital Asset", news3_time: "1 day ago",
                news4_title: "Solana Ecosystem Booms, Fueled by Memecoin Frenzy", news4_source: "Crypto News", news4_time: "2 days ago",
                disclaimer: "Disclaimer: All information provided by Oracoin is for informational purposes only and should not be considered as investment advice. Investing in cryptocurrencies involves the risk of loss. All investment decisions should be made carefully at your own risk.",
            }
        };

        // --- 렌더링 ---
        function render() {
            elements.cryptoContainer.innerHTML = '';
            let dataToRender = [...state.displayedCoinsData];

            if (state.showWatchlistOnly) dataToRender = dataToRender.filter(c => state.watchlist.includes(c.id));
            if (state.searchTerm) dataToRender = dataToRender.filter(c => c.name.toLowerCase().includes(state.searchTerm) || c.symbol.toLowerCase().includes(state.searchTerm));
            
            dataToRender.sort((a, b) => {
                let valA = a[state.currentSort.key], valB = b[state.currentSort.key];
                if (typeof valA === 'string') { valA = valA.toLowerCase(); valB = valB.toLowerCase(); }
                return state.currentSort.order === 'asc' ? (valA > valB ? 1 : -1) : (valA < valB ? 1 : -1);
            });
            
            updateNoResultsMessage(dataToRender.length);
            dataToRender.forEach(createCoinCard);
        }
        
        function updateNoResultsMessage(count) {
             if (count === 0) {
                elements.noResults.style.display = 'block';
                const T = translations[state.lang];
                elements.noResults.innerHTML = `<svg class="mx-auto h-12 w-12 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><h3 class="mt-2 text-sm font-medium text-white">${T.no_results}</h3>`;
            } else {
                elements.noResults.style.display = 'none';
            }
        }

        function createCoinCard(coin) {
            const isFavorited = state.watchlist.includes(coin.id);
            const change24h = coin.price_change_percentage_24h_in_currency || 0;
            const price = coin.current_price || 0;
            const T = translations[state.lang];
            
            let predictionText = '', predictionClass = '', basisText = '', timeframeText = '';
            const predictionChange = coin.prediction_change ?? change24h;
            
            if (state.activeTimeframe === '1h') timeframeText = T.time_1h;
            else if (state.activeTimeframe === '4h') timeframeText = T.time_4h;
            else timeframeText = T.time_24h;

            const threshold = state.activeTimeframe === '24h' ? 0.5 : 0.2;
            const formattedChange = predictionChange.toFixed(2);

            if (predictionChange > threshold) {
                predictionText = T.predict_up; predictionClass = 'predict-up';
                basisText = T.basis_up.replace('{timeframe}', timeframeText).replace('{change}', formattedChange).replace('{threshold}', threshold);
            } else if (predictionChange < -threshold) {
                predictionText = T.predict_down; predictionClass = 'predict-down';
                basisText = T.basis_down.replace('{timeframe}', timeframeText).replace('{change}', formattedChange).replace('{threshold}', threshold);
            } else {
                predictionText = T.predict_stable; predictionClass = 'predict-stable';
                basisText = T.basis_stable.replace('{timeframe}', timeframeText).replace('{change}', formattedChange).replace('{threshold}', threshold);
            }

            const card = document.createElement('div');
            card.className = 'bg-gray-800/50 backdrop-blur-sm border border-gray-700 p-5 rounded-xl shadow-lg flex flex-col justify-between relative transition-all duration-300 hover:shadow-blue-500/30 hover:-translate-y-1';
            card.innerHTML = `
                <div class="absolute top-2 right-2 flex items-center space-x-2">
                    <span class="star-icon text-2xl ${isFavorited ? 'favorited' : 'text-gray-600'}" data-id="${coin.id}">★</span>
                    <button class="remove-coin-btn text-gray-500 hover:text-white text-2xl leading-none" data-id="${coin.id}">&times;</button>
                </div>
                <div class="cursor-pointer" data-coin-id="${coin.id}">
                    <div class="flex items-center pr-12"><img src="${coin.image}" class="w-10 h-10 mr-4"><div><h2 class="text-xl font-bold">${coin.name}</h2><p class="text-gray-400 text-sm uppercase">${coin.symbol}</p></div></div>
                    <div class="mt-4"><p class="text-3xl font-semibold">${price.toLocaleString(state.lang === 'ko' ? 'ko-KR' : 'en-US', { style: 'currency', currency: state.currency })}</p><p class="text-lg ${change24h >= 0 ? 'text-green-400' : 'text-red-400'}">${change24h >= 0 ? '▲' : '▼'} ${change24h.toFixed(2)}% (24h)</p></div>
                </div>
                <div class="mt-4 pt-4 border-t border-gray-700">
                    <p class="text-sm text-gray-400 mb-1">${timeframeText} ${T.watchlist.includes('목록') ? '기준 추세 예측' : 'Trend Prediction'}</p>
                    <p class="text-lg font-bold ${predictionClass}">${predictionText}</p>
                    <p class="text-xs text-gray-500 mt-1">${basisText}</p>
                </div>`;
            elements.cryptoContainer.appendChild(card);
        }
        
        function populateSidebar() {
            elements.coinListSidebar.innerHTML = '';
            state.allCoinsForSidebar.forEach(coin => {
                const isDisplayed = state.displayedCoinIds.has(coin.id);
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between p-2 rounded-md hover:bg-gray-700';
                item.innerHTML = `<div class="flex items-center overflow-hidden"><img src="${coin.image}" class="w-6 h-6 mr-2"><span class="text-sm truncate">${coin.name}</span></div><button class="add-coin-btn text-green-400 text-xl font-bold disabled:text-gray-600" data-id="${coin.id}" ${isDisplayed ? 'disabled' : ''}>+</button>`;
                elements.coinListSidebar.appendChild(item);
            });
        }

        function displayNews() {
            const T = translations[state.lang];
            const newsData = [
                { title: T.news1_title, source: T.news1_source, time: T.news1_time, url: "#" },
                { title: T.news2_title, source: T.news2_source, time: T.news2_time, url: "#" },
                { title: T.news3_title, source: T.news3_source, time: T.news3_time, url: "#" },
                { title: T.news4_title, source: T.news4_source, time: T.news4_time, url: "#" },
            ];

            elements.newsContainer.innerHTML = '';
            newsData.forEach(article => {
                const newsCard = document.createElement('a');
                newsCard.href = article.url;
                newsCard.target = '_blank';
                newsCard.rel = 'noopener noreferrer';
                newsCard.className = 'block bg-gray-800/50 backdrop-blur-sm border border-gray-700 p-5 rounded-lg hover:bg-gray-700/50 transition-colors duration-300';
                newsCard.innerHTML = `<h3 class="font-bold text-lg text-blue-300 mb-2">${article.title}</h3><div class="flex justify-between items-center text-sm text-gray-400"><span>${article.source}</span><span>${article.time}</span></div>`;
                elements.newsContainer.appendChild(newsCard);
            });
        }

        // --- 데이터 가져오기 ---
        async function fetchSidebarCoins() {
            try {
                const response = await fetch(`https://api.coingecko.com/api/v3/coins/markets?vs_currency=${state.currency}&order=market_cap_desc&per_page=100&page=1&sparkline=false&x_cg_demo_api_key=${apiKey}`);
                if (!response.ok) throw new Error('Failed to load sidebar coin list');
                state.allCoinsForSidebar = await response.json();
                populateSidebar();
            } catch (error) {
                elements.coinListSidebar.innerHTML = `<p class="text-red-500 text-sm p-2">${error.message}</p>`;
            }
        }

        async function loadData() {
            if (state.displayedCoinIds.size === 0) {
                state.displayedCoinsData = [];
                render();
                return;
            }
            setLoading(true);
            try {
                const ids = Array.from(state.displayedCoinIds).join(',');
                const baseResponse = await fetch(`https://api.coingecko.com/api/v3/coins/markets?vs_currency=${state.currency}&ids=${ids}&order=market_cap_desc&price_change_percentage=24h&x_cg_demo_api_key=${apiKey}`);
                if (!baseResponse.ok) throw new Error(`API Request Failed`);
                const baseData = await baseResponse.json();

                if (state.activeTimeframe === '24h') {
                    state.displayedCoinsData = baseData;
                } else {
                    const hours = state.activeTimeframe === '1h' ? 1 : 4;
                    const detailedData = [];
                    for (const coin of baseData) {
                        try {
                            const chartResponse = await fetch(`https://api.coingecko.com/api/v3/coins/${coin.id}/market_chart?vs_currency=${state.currency}&days=2&x_cg_demo_api_key=${apiKey}`);
                            if (!chartResponse.ok) { 
                                coin.prediction_change = coin.price_change_percentage_24h_in_currency; 
                                continue; 
                            }
                            const chartData = await chartResponse.json();
                            const prices = chartData.prices;
                            if (!prices || prices.length < 2) { 
                                coin.prediction_change = coin.price_change_percentage_24h_in_currency; 
                                continue; 
                            }
                            const currentPriceData = prices[prices.length - 1];
                            const targetTimestamp = currentPriceData[0] - hours * 60 * 60 * 1000;
                            const pastPriceData = prices.slice().reverse().find(p => p[0] <= targetTimestamp);
                            if (pastPriceData) {
                                coin.prediction_change = ((currentPriceData[1] - pastPriceData[1]) / pastPriceData[1]) * 100;
                            } else {
                                coin.prediction_change = coin.price_change_percentage_24h_in_currency;
                            }
                        } catch (e) {
                            coin.prediction_change = coin.price_change_percentage_24h_in_currency;
                        } finally {
                            detailedData.push(coin);
                        }
                    }
                    state.displayedCoinsData = detailedData;
                }
                render();
                elements.lastUpdated.textContent = `${translations[state.lang].last_update} ${new Date().toLocaleTimeString(state.lang === 'ko' ? 'ko-KR' : 'en-US')}`;
            } catch (error) {
                console.error("Data loading error:", error);
                elements.cryptoContainer.innerHTML = `<p class="text-red-500 text-center col-span-full">${error.message}</p>`;
            } finally {
                setLoading(false);
            }
        }
        
        // --- 이벤트 핸들러 ---
        function setupEventListeners() {
            elements.sidebarToggle.addEventListener('click', () => {
                elements.sidebar.classList.toggle('-translate-x-full');
                elements.sidebarOverlay.classList.toggle('hidden');
            });
            elements.sidebarOverlay.addEventListener('click', () => {
                elements.sidebar.classList.add('-translate-x-full');
                elements.sidebarOverlay.classList.add('hidden');
            });

            elements.searchInput.addEventListener('input', (e) => { state.searchTerm = e.target.value.toLowerCase(); render(); });
            elements.sortButtons.forEach(button => button.addEventListener('click', (e) => {
                const sortKeyMap = {'sort-name': 'name', 'sort-price': 'current_price', 'sort-change': 'price_change_percentage_24h_in_currency'};
                const newKey = sortKeyMap[e.target.id];
                if (state.currentSort.key === newKey) state.currentSort.order = state.currentSort.order === 'asc' ? 'desc' : 'asc';
                else { state.currentSort.key = newKey; state.currentSort.order = newKey === 'price_change_percentage_24h_in_currency' ? 'desc' : 'asc'; }
                elements.sortButtons.forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                render();
            }));
            elements.watchlistToggle.addEventListener('change', (e) => { state.showWatchlistOnly = e.target.checked; render(); });
            elements.timeframeButtons.forEach(button => button.addEventListener('click', (e) => {
                state.activeTimeframe = e.target.id.replace('btn-', '');
                elements.timeframeButtons.forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                loadData();
            }));
            elements.cryptoContainer.addEventListener('click', (e) => {
                const target = e.target;
                if (target.classList.contains('star-icon')) {
                    toggleWatchlist(target.dataset.id);
                    target.classList.toggle('favorited'); target.classList.toggle('text-gray-600');
                } else if (target.classList.contains('remove-coin-btn')) {
                    state.displayedCoinIds.delete(target.dataset.id);
                    loadData(); populateSidebar();
                } else if (target.closest('[data-coin-id]')) {
                    openModal(target.closest('[data-coin-id]').dataset.coinId);
                }
            });
            elements.coinListSidebar.addEventListener('click', (e) => {
                if (e.target.classList.contains('add-coin-btn')) {
                    if (state.displayedCoinIds.size >= 6) { showLimitMessage(); return; }
                    const coinId = e.target.dataset.id;
                    state.displayedCoinIds.add(coinId);
                    e.target.disabled = true;
                    loadData();
                }
            });
            elements.langButtons.forEach(button => button.addEventListener('click', (e) => {
                setLanguage(e.target.id.replace('lang-', ''));
            }));
        }

        function toggleWatchlist(coinId) {
            const index = state.watchlist.indexOf(coinId);
            if (index > -1) state.watchlist.splice(index, 1); else state.watchlist.push(coinId);
            localStorage.setItem('cryptoWatchlist', JSON.stringify(state.watchlist));
            if(state.showWatchlistOnly) render();
        }
        
        // --- 유틸리티 함수 ---
        function setLoading(isLoading) {
            if (isLoading) {
                let skeletonHTML = '';
                const count = state.displayedCoinIds.size > 0 ? state.displayedCoinIds.size : 6;
                for (let i = 0; i < count; i++) {
                    skeletonHTML += `
                    <div class="skeleton-card animate-pulse">
                        <div class="flex items-center"><div class="skeleton w-10 h-10 rounded-full mr-4"></div><div class="flex-1 space-y-2"><div class="skeleton h-4 w-3/4"></div><div class="skeleton h-3 w-1/4"></div></div></div>
                        <div class="mt-4 space-y-2"><div class="skeleton h-8 w-1/2"></div><div class="skeleton h-4 w-1/3"></div></div>
                        <div class="mt-4 pt-4 border-t border-gray-700 space-y-2"><div class="skeleton h-3 w-1/4"></div><div class="skeleton h-4 w-1/2"></div><div class="skeleton h-3 w-full"></div></div>
                    </div>`;
                }
                elements.loadingIndicator.innerHTML = skeletonHTML;
                elements.cryptoContainer.innerHTML = '';
            } else {
                elements.loadingIndicator.innerHTML = '';
            }
        }

        function showLimitMessage() {
            elements.limitMessage.style.opacity = '1';
            setTimeout(() => { elements.limitMessage.style.opacity = '0'; }, 2000);
        }

        function setLanguage(lang) {
            state.lang = lang;
            state.currency = lang === 'ko' ? 'krw' : 'usd';
            localStorage.setItem('cryptoLang', lang);

            document.documentElement.lang = lang;
            elements.langButtons.forEach(btn => btn.classList.remove('active'));
            document.getElementById(`lang-${lang}`).classList.add('active');
            
            updateUIText();
            displayNews();
            fetchSidebarCoins();
            loadData();
        }

        function updateUIText() {
            const T = translations[state.lang];
            document.querySelectorAll('[data-lang-key]').forEach(el => {
                const key = el.dataset.langKey;
                if (T[key]) {
                    if (el.placeholder !== undefined) el.placeholder = T[key];
                    else el.textContent = T[key];
                }
            });
        }

        // --- 모달 관리 ---
        async function openModal(coinId) {
            const coin = state.displayedCoinsData.find(c => c.id === coinId);
            if (!coin) return;
            const T = translations[state.lang];
            const locale = state.lang === 'ko' ? 'ko-KR' : 'en-US';
            
            elements.modalContent.innerHTML = `<div class="text-center"><svg class="animate-spin h-8 w-8 text-blue-400 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></div>`;
            elements.modalOverlay.style.display = 'flex';
            setTimeout(() => { elements.modalContent.style.transform = 'scale(1)'; elements.modalContent.style.opacity = '1'; }, 10);

            try {
                const [detailsRes, chartRes] = await Promise.all([
                    fetch(`https://api.coingecko.com/api/v3/coins/${coinId}?localization=true&tickers=false&market_data=false&community_data=false&developer_data=false&sparkline=false&x_cg_demo_api_key=${apiKey}`),
                    fetch(`https://api.coingecko.com/api/v3/coins/${coinId}/market_chart?vs_currency=${state.currency}&days=7&x_cg_demo_api_key=${apiKey}`)
                ]);
                if (!detailsRes.ok || !chartRes.ok) throw new Error('Failed to fetch modal data');
                const details = await detailsRes.json();
                const chartData = await chartRes.json();

                const description = details.description?.[state.lang] || details.description?.en || 'No description available.';
                const website = details.links?.homepage?.[0];

                elements.modalContent.innerHTML = `
                    <button id="modal-close-inner" class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl leading-none">&times;</button>
                    <div class="flex items-center mb-4"><img src="${coin.image}" class="w-12 h-12 mr-4"><div><h2 class="text-2xl font-bold">${coin.name}</h2><p class="text-gray-400 uppercase">${coin.symbol}</p></div></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-3 text-lg">
                            <div class="flex justify-between"><span class="text-gray-400">${T.modal_price}</span><span class="font-semibold">${(coin.current_price || 0).toLocaleString(locale, { style: 'currency', currency: state.currency })}</span></div>
                            <div class="flex justify-between"><span class="text-gray-400">${T.modal_mcap}</span><span>${(coin.market_cap || 0).toLocaleString(locale, { style: 'currency', currency: state.currency, minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span></div>
                            <div class="flex justify-between"><span class="text-gray-400">${T.modal_vol}</span><span>${(coin.total_volume || 0).toLocaleString(locale, { style: 'currency', currency: state.currency, minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span></div>
                            <div class="flex justify-between"><span class="text-gray-400">${T.modal_high}</span><span class="text-green-400">${(coin.high_24h || 0).toLocaleString(locale, { style: 'currency', currency: state.currency })}</span></div>
                            <div class="flex justify-between"><span class="text-gray-400">${T.modal_low}</span><span class="text-red-400">${(coin.low_24h || 0).toLocaleString(locale, { style: 'currency', currency: state.currency })}</span></div>
                        </div>
                        <div>
                            <h3 class="font-bold mb-2">${T.modal_chart_title}</h3>
                            <canvas id="priceChart"></canvas>
                        </div>
                    </div>
                    <div class="mt-6">
                        <h3 class="font-bold mb-2">${T.modal_desc_title}</h3>
                        <p class="text-sm text-gray-400 max-h-24 overflow-y-auto">${description.split('. ')[0]}.</p>
                    </div>
                    ${website ? `<div class="mt-4"><h3 class="font-bold mb-2">${T.modal_links_title}</h3><a href="${website}" target="_blank" rel="noopener noreferrer" class="inline-block bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">${T.modal_website}</a></div>` : ''}
                `;
                
                renderChart(chartData.prices);
                document.getElementById('modal-close-inner').addEventListener('click', closeModal);

            } catch(e) {
                elements.modalContent.innerHTML = `<p class="text-red-400">Failed to load details.</p>`;
            }
        }
        
        function renderChart(prices) {
            const ctx = document.getElementById('priceChart').getContext('2d');
            if (state.chartInstance) {
                state.chartInstance.destroy();
            }
            const labels = prices.map(p => new Date(p[0]).toLocaleDateString(state.lang === 'ko' ? 'ko-KR' : 'en-US'));
            const data = prices.map(p => p[1]);
            const borderColor = data[0] < data[data.length - 1] ? '#22c55e' : '#ef4444';

            state.chartInstance = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets: [{ label: 'Price', data, borderColor, borderWidth: 2, pointRadius: 0, tension: 0.1 }] },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { ticks: { display: false }, grid: { color: 'rgba(255, 255, 255, 0.1)' } },
                        y: { ticks: { color: '#9ca3af' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } }
                    }
                }
            });
        }

        function closeModal() {
            if (state.chartInstance) {
                state.chartInstance.destroy();
                state.chartInstance = null;
            }
            elements.modalContent.style.transform = 'scale(0.95)';
            elements.modalContent.style.opacity = '0';
            setTimeout(() => { elements.modalOverlay.style.display = 'none'; }, 300);
        }
        elements.modalOverlay.addEventListener('click', (e) => { if (e.target === elements.modalOverlay) closeModal(); });
        elements.modalClose.addEventListener('click', closeModal);

        // 초기화
        async function initialize() {
            const savedLang = localStorage.getItem('cryptoLang') || (navigator.language.startsWith('ko') ? 'ko' : 'en');
            setupEventListeners();
            setLanguage(savedLang);
            setInterval(loadData, 60000); // 60초마다 데이터 갱신
        }
        initialize();
    </script>
    <style>
        #watchlist-toggle:checked ~ .dot { transform: translateX(100%); background-color: #3b82f6; }
    </style>
</body>
</html>
